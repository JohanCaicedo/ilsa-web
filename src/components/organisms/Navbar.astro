---
// src/components/organisms/Navbar.astro
import NavLink from "../atoms/navbar/NavLink.astro";
import NavDropdown from "../atoms/navbar/NavDropdown.astro";
import NavButton from "../atoms/navbar/NavButton.astro";
import LiquidContainer from "../experimental/LiquidContainer.astro";
import {
    HIDE_SENSITIVE_AUTHORS,
    SENSITIVE_AUTHORS,
} from "../../lib/presentationConfig";
import { collectionsConfig } from "../../lib/collections";
import { authorsConfig } from "../../lib/authors";

const navStructure = [
    {
        type: "dropdown",
        text: "Nosotros",
        href: "/nosotros",
        items: [
            {
                label: "Dirección Ejecutiva",
                href: "/nosotros/direccion-ejecutiva",
            },
            { label: "Junta Directiva", href: "/nosotros/junta-directiva" },
        ],
    },
    {
        type: "dropdown",
        text: "Opinión",
        href: "/opinion",
        // Mapping specific authors based on configuration
        items: Object.entries(authorsConfig)
            .filter(
                ([slug]) =>
                    !HIDE_SENSITIVE_AUTHORS ||
                    !SENSITIVE_AUTHORS.includes(slug),
            )
            .map(([slug, author]) => ({
                label: author.name,
                href: `/opinion/${slug}`,
            }))
            .sort((a, b) => a.label.localeCompare(b.label)),
    },
    {
        type: "dropdown",
        text: "Publicaciones",
        href: "/publicaciones", // Default or list page? Using generic one or first
        items: Object.entries(collectionsConfig).map(([slug, config]) => ({
            label: config.title,
            href: `/publicaciones/${slug}`,
        })),
    },
];
---

<!-- 
    Navbar "Liquid Glass"
    Hemos reemplazado los estilos hardcoded de backdrop por el componente LiquidContainer
    que maneja la física de refracción y el spotlight.
-->
<div class="fixed top-0 left-0 right-0 z-50 p-4">
    <LiquidContainer
        intensity="medium"
        clipContent={false}
        frosted={true}
        class="w-full flex items-center px-6 md:px-10 py-3 rounded-full text-slate-800 text-sm shadow-lg shadow-slate-200/50 ios-glass-fix transition-all duration-300"
    >
        <nav class="flex items-center w-full">
            <a
                href="/"
                id="ilsa-logo"
                class="shrink-0 flex items-center pr-10"
                aria-label="ILSA Home"
            >
                <img
                    src="https://api.ilsa.org.co/wp-content/uploads/2025/08/ILSA-Logo-2025-16.svg"
                    alt="ILSA Logo"
                    class="h-12 w-auto object-contain"
                />
            </a>

            <!-- Desktop Menu -->
            <div
                class="hidden md:flex items-center gap-8 font-medium h-10 ml-8"
            >
                {
                    navStructure.map((item) =>
                        item.type === "link" ? (
                            <NavLink href={item.href!} text={item.text} />
                        ) : (
                            <NavDropdown
                                text={item.text}
                                items={item.items!}
                                href={item.href}
                            />
                        ),
                    )
                }
            </div>

            <!-- Spacer to push actions to right -->
            <div class="flex-grow"></div>

            <!-- Desktop Actions -->
            <div class="hidden md:flex items-center gap-4">
                <a
                    href="/actividades"
                    class="group relative px-6 py-2 rounded-full font-medium text-[#4e7cce] text-sm transition-all duration-300 transform hover:scale-105 hover:-translate-y-0.5 ml-2 mr-2 border border-[#4e7cce] bg-transparent hover:bg-[#adbee0] hover:text-white hover:border-[#adbee0] hover:shadow-[0_0_15px_rgba(173,190,224,0.4)]"
                >
                    <!-- Content -->

                    <!-- Content -->
                    <span class="relative z-10 flex items-center gap-2">
                        <span>Actividades</span>
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-4 h-4 transition-transform duration-300 group-hover:rotate-12"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <rect
                                x="3"
                                y="4"
                                width="18"
                                height="18"
                                rx="2"
                                ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </span>
                </a>
                <a
                    href="/donaciones"
                    class="group relative px-6 py-2 rounded-full font-medium text-white text-sm transition-all duration-300 transform hover:scale-105 hover:-translate-y-0.5"
                >
                    <!-- Background & Glow -->
                    <div
                        class="absolute inset-0 bg-[#4e7cce] rounded-full transition-all duration-300 group-hover:shadow-[0_0_20px_rgba(78,124,206,0.6)] group-hover:brightness-110"
                    >
                    </div>

                    <!-- Shimmer Effect -->
                    <div
                        class="absolute inset-0 rounded-full overflow-hidden opacity-0 group-hover:opacity-100 transition-opacity duration-500"
                    >
                        <div
                            class="absolute top-0 left-0 w-[200%] h-full bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"
                        >
                        </div>
                    </div>

                    <!-- Content -->
                    <span class="relative z-10 flex items-center gap-2">
                        <span>Donaciones</span>
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-4 h-4 transition-transform duration-300 group-hover:rotate-12"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                        >
                            <path
                                d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"
                            ></path>
                        </svg>
                    </span>
                </a>
            </div>

            <!-- Mobile Toggle -->
            <div class="md:hidden ml-auto flex items-center">
                <button
                    id="menuToggle"
                    class="text-slate-700 hover:text-[#4a7dbf] transition-colors p-3 relative z-[60]"
                    aria-label="Abrir menú"
                >
                    <svg
                        class="w-7 h-7"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                        viewBox="0 0 24 24"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </nav>
    </LiquidContainer>

    <!-- Mobile Menu Overlay (Separado para no heredar el liquid container de forma extraña) -->
    <div
        id="mobileMenu"
        class="absolute hidden top-[calc(100%+1rem)] right-0 left-0 mx-4 max-h-[80vh] overflow-y-auto bg-white/98 backdrop-blur-2xl border border-white/60 rounded-3xl p-8 flex flex-col items-center gap-6 shadow-2xl shadow-slate-300/50 z-[100] animate-in fade-in slide-in-from-top-4 duration-300 ios-glass-fix touch-scroll"
    >
        {
            navStructure.map((item) => (
                <div class="w-full text-center">
                    {item.type === "link" ? (
                        <a
                            class="block py-2 text-lg font-bold text-slate-800 hover:text-[#4a7dbf]"
                            href={item.href}
                        >
                            {item.text}
                        </a>
                    ) : (
                        <div class="flex flex-col gap-2">
                            <span class="block py-1 text-xs font-black uppercase tracking-widest text-[#4a7dbf]/60 mt-2">
                                {item.text}
                            </span>
                            {item.items?.map((sub) => (
                                <a
                                    class="block py-1 text-base text-slate-600 hover:text-[#4a7dbf]"
                                    href={sub.href}
                                >
                                    {sub.label}
                                </a>
                            ))}
                        </div>
                    )}
                </div>
            ))
        }

        <div class="w-full h-px bg-slate-100 my-2"></div>

        <div class="flex flex-col gap-3 w-full">
            <NavButton
                variant="secondary"
                href="/actividades"
                class="w-full justify-center"
            >
                Actividades
            </NavButton>
            <div
                class="rainbow w-full relative z-0 bg-white/15 overflow-hidden p-[1px] flex items-center justify-center rounded-full hover:scale-105 hover:shadow-[0_0_20px_rgba(78,124,206,0.6)] transition duration-300 active:scale-100 group"
            >
                <a
                    href="/donaciones"
                    class="w-full px-4 text-sm py-3 text-white rounded-full font-medium bg-gray-900/90 backdrop-blur block text-center relative z-10"
                >
                    Donaciones
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("astro:page-load", () => {
        const menuToggle = document.getElementById("menuToggle");
        const mobileMenu = document.getElementById("mobileMenu");

        if (menuToggle && mobileMenu) {
            menuToggle.addEventListener("click", () => {
                // Toggle logic
                if (mobileMenu.classList.contains("hidden")) {
                    mobileMenu.classList.remove("hidden");
                    mobileMenu.classList.add("flex");
                    // Prevent body scroll
                    document.body.style.overflow = "hidden";
                } else {
                    mobileMenu.classList.add("hidden");
                    mobileMenu.classList.remove("flex");
                    // Restore body scroll
                    document.body.style.overflow = "";
                }
            });

            // Close menu when clicking navigation links
            const mobileLinks = mobileMenu.querySelectorAll("a");
            mobileLinks.forEach((link) => {
                link.addEventListener("click", () => {
                    mobileMenu.classList.add("hidden");
                    mobileMenu.classList.remove("flex");
                    document.body.style.overflow = "";
                });
            });
        }
    });

    // Triple-Tap Easter Egg Activation (Mobile Support)
    document.addEventListener("astro:page-load", () => {
        const logo = document.getElementById("ilsa-logo");
        if (!logo) return;

        let tapCount = 0;
        let tapTimer: number | null = null;

        const resetTaps = () => {
            tapCount = 0;
            if (tapTimer) clearTimeout(tapTimer);
            tapTimer = null;
        };

        logo.addEventListener("click", (e: MouseEvent) => {
            // Prevenir navegación en taps 2 y 3
            if (tapCount > 0) {
                e.preventDefault();
            }

            tapCount++;

            // Reset timer
            if (tapTimer) clearTimeout(tapTimer);

            // Si llega a 3 taps, activar Easter Egg
            if (tapCount === 3) {
                console.log("Triple-tap detected! Activating Easter Egg...");

                // Disparar evento personalizado que el EasterEggManager escuchará
                const activationEvent = new CustomEvent("activate-easter-egg");
                window.dispatchEvent(activationEvent);

                resetTaps();
            } else {
                // Reset después de 600ms si no llega a 3
                tapTimer = window.setTimeout(resetTaps, 600);
            }
        });
    });
</script>

<style>
    @keyframes rotate {
        100% {
            transform: rotate(1turn);
        }
    }

    .rainbow::before {
        content: "";
        position: absolute;
        z-index: -1;
        left: -50%;
        top: -50%;
        width: 200%;
        height: 200%;
        background-position: 100% 50%;
        background-repeat: no-repeat;
        filter: blur(4px);
        background-image: linear-gradient(
            90deg,
            transparent,
            #4e7cce,
            #5e3b69,
            #4e7cce,
            transparent
        );
        animation: rotate 3s linear infinite;
        background-size: 50% 50%;
    }
</style>
