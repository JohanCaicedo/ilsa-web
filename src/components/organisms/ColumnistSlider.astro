---
import OpinionCard from "../molecules/OpinionCard.astro";
import SliderArrow from "../atoms/SliderArrow.astro";
import SliderProgress from "../atoms/SliderProgress.astro";
import GradientText from "../atoms/GradientText.astro";

import type { CardPostNode } from "../../lib/wp";

interface Props {
  posts: CardPostNode[];
}

const { posts } = Astro.props;
---

<section
  class="columnist-slider-container mx-auto mt-16 mb-16 w-full max-w-[1400px] px-4 md:px-8 relative group"
  data-slider-type="columnist"
>
  <div
    class="mb-6 flex flex-col md:flex-row items-center md:items-end justify-center md:justify-between border-b border-border pb-4 gap-4 md:gap-0"
  >
    <div class="w-full text-center md:text-left">
      <GradientText
        text="Archivo de Opinión"
        size="text-xl md:text-2xl"
        weight="font-black"
        from="var(--ilsa-blue-dark)"
        to="var(--ilsa-blue)"
        class="uppercase tracking-tighter block w-fit mx-auto md:mx-0 text-center"
      />
    </div>

    <div class="hidden md:flex items-center gap-2">
      <SliderArrow direction="left" data-slider-prev />
      <SliderArrow direction="right" data-slider-next />
    </div>
  </div>

  <div
    class="flex w-full gap-6 overflow-x-auto py-4 px-1 cursor-grab active:cursor-grabbing select-none [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden snap-x snap-mandatory focus-visible:ring-2 focus-visible:ring-[#4E7CCE] focus-visible:outline-none rounded-xl"
    data-slider-track
    tabindex="0"
    aria-label="Lista de columnas de opinión"
    role="region"
  >
    {
      posts.map((post) => {
        const img =
          post.featuredImage?.node?.sourceUrl ||
          "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Crect fill='%23e5e7eb' width='400' height='400'/%3E%3C/svg%3E";
        const authorName = post.categories?.nodes[0]?.name || "Opinión";
        const formattedDate = new Date(post.date).toLocaleDateString("es-CO", {
          day: "numeric",
          month: "short",
        });

        return (
          <div class="snap-start shrink-0 transition-opacity duration-300">
            <OpinionCard
              title={post.title}
              author={authorName}
              image={img}
              date={formattedDate}
              uri={post.uri}
            />
          </div>
        );
      })
    }
  </div>

  <SliderProgress data-slider-progress />
</section>

<script>
  function setupColumnistSliders() {
    const containers = document.querySelectorAll(
      '[data-slider-type="columnist"]',
    );

    containers.forEach((container) => {
      const track = container.querySelector(
        "[data-slider-track]",
      ) as HTMLElement | null;
      const progress = container.querySelector(
        "[data-slider-progress]",
      ) as HTMLElement | null;
      const btnPrev = container.querySelector("[data-slider-prev]");
      const btnNext = container.querySelector("[data-slider-next]");

      if (!track) return;

      // Robust Arrow Wiring
      if (btnPrev) {
        // Ensure button is clickable over other elements
        (btnPrev as HTMLElement).style.zIndex = "10";
        btnPrev.addEventListener("click", (e) => {
          e.stopPropagation(); // Prevent bubbling issues
          track.scrollBy({ left: -320, behavior: "smooth" });
        });
      }

      if (btnNext) {
        (btnNext as HTMLElement).style.zIndex = "10";
        btnNext.addEventListener("click", (e) => {
          e.stopPropagation();
          track.scrollBy({ left: 320, behavior: "smooth" });
        });
      }

      // Drag Logic
      let isDown = false;
      let startX = 0;
      let scrollLeft = 0;
      let moved = false;

      const onMouseDown = (e: MouseEvent) => {
        isDown = true;
        moved = false;
        track.classList.add("active");
        const rect = track.getBoundingClientRect();
        startX = e.pageX - rect.left;
        scrollLeft = track.scrollLeft;

        // Temporarily disable snap for smooth dragging
        track.style.scrollSnapType = "none";
        track.style.scrollBehavior = "auto";
      };

      const onMouseLeave = () => {
        if (!isDown) return;
        isDown = false;
        track.classList.remove("active");
        track.style.scrollSnapType = "x mandatory";
        track.style.scrollBehavior = "smooth";
      };

      const onMouseUp = (e: MouseEvent) => {
        if (!isDown) return;
        onMouseLeave();
        // If we barely moved, it's a click, let it bubble.
        // If we moved significantly, it's a drag, consume the click.
        if (moved) {
          e.preventDefault();
          e.stopPropagation();
        }
      };

      const onMouseMove = (e: MouseEvent) => {
        if (!isDown) return;
        e.preventDefault(); // Prevent text selection

        const rect = track.getBoundingClientRect();
        const x = e.pageX - rect.left;
        const walk = (x - startX) * 1.5; // Friction multiplier

        if (Math.abs(walk) > 5) {
          moved = true;
          track.scrollLeft = scrollLeft - walk;
        }
      };

      // Progress Bar Logic
      const updateProgress = () => {
        if (!progress) return;
        const maxScroll = track.scrollWidth - track.clientWidth;
        if (maxScroll > 0) {
          const percentage = (track.scrollLeft / maxScroll) * 100;
          progress.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
        }
      };

      // Events
      track.addEventListener("mousedown", onMouseDown);
      track.addEventListener("mouseleave", onMouseLeave);
      track.addEventListener("mouseup", onMouseUp);
      track.addEventListener("mousemove", onMouseMove);

      // Capture click to prevent opening links if dragged
      track.addEventListener(
        "click",
        (e) => {
          if (moved) {
            e.preventDefault();
            e.stopPropagation();
          }
        },
        { capture: true },
      );

      track.addEventListener("scroll", updateProgress, { passive: true });
      window.addEventListener("resize", updateProgress);

      // Initial calculation
      requestAnimationFrame(updateProgress);
    });
  }

  // Init
  setupColumnistSliders();
  document.addEventListener("astro:page-load", setupColumnistSliders);
</script>
