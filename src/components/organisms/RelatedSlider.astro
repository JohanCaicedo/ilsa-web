---
import OpinionCard from "../molecules/OpinionCard.astro";
import SliderArrow from "../atoms/SliderArrow.astro";
import SliderProgress from "../atoms/SliderProgress.astro";

interface Props {
  posts: any[];
}

const { posts } = Astro.props;
---

<section class="mx-auto mt-16 mb-16 w-full max-w-[1400px] px-4 md:px-8 relative group">
  
  <div class="mb-6 flex items-end justify-between border-b border-border pb-4">
    <h3 class="text-xl md:text-2xl font-black tracking-tighter text-foreground uppercase">
      Últimos Artículos
    </h3>
    
    <div class="hidden md:flex items-center gap-2">
      <SliderArrow direction="left" id="btn-prev" />
      <SliderArrow direction="right" id="btn-next" />
    </div>
  </div>

  <div 
    id="track-container"
    class="flex w-full gap-6 overflow-x-auto py-4 px-1 cursor-grab active:cursor-grabbing select-none [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden snap-x snap-mandatory"
  >
    {posts.map((post) => {
      const img = post.featuredImage?.node?.sourceUrl || "https://ilsa.org.co/wp-content/uploads/2021/02/placeholder.jpg";
      const authorName = post.categories?.nodes[0]?.name || "Opinión";
      const formattedDate = new Date(post.date).toLocaleDateString("es-CO", { day: 'numeric', month: 'short' });

      return (
        <div class="snap-start shrink-0 transition-opacity duration-300">
          <OpinionCard 
            title={post.title}
            author={authorName}
            image={img}
            date={formattedDate}
            uri={post.uri}
          />
        </div>
      );
    })}
  </div>

  <SliderProgress id="progress-bar" />

</section>

<script>
  function initSlider() {
    const slider = document.getElementById('track-container') as HTMLElement | null;
    const progressBar = document.getElementById('progress-bar') as HTMLElement | null;
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    if (!slider || !progressBar) return;

    // --- 1. LÓGICA DE DRAG & DROP MEJORADA ---
    let isDown = false;
    let startX = 0;
    let scrollLeft = 0;

    slider.addEventListener('mousedown', (e: MouseEvent) => {
      isDown = true;
      slider.classList.add('active');
      // CORRECCIÓN: Usamos getBoundingClientRect() para mayor precisión en layouts centrados
      const rect = slider.getBoundingClientRect();
      startX = e.pageX - rect.left;
      scrollLeft = slider.scrollLeft;
      
      // Desactivamos snap momentáneamente para suavidad
      slider.style.scrollSnapType = 'none';
    });

    const stopDragging = () => {
      isDown = false;
      slider.classList.remove('active');
      slider.style.scrollSnapType = 'x mandatory'; // Reactivamos snap
    };

    slider.addEventListener('mouseleave', stopDragging);
    slider.addEventListener('mouseup', stopDragging);

    slider.addEventListener('mousemove', (e: MouseEvent) => {
      if (!isDown) return;
      e.preventDefault();
      
      const rect = slider.getBoundingClientRect();
      const x = e.pageX - rect.left;
      const walk = (x - startX) * 1.5; // Velocidad del arrastre
      slider.scrollLeft = scrollLeft - walk;
    });

    // --- 2. BARRA DE PROGRESO ---
    const updateProgress = () => {
      const maxScroll = slider.scrollWidth - slider.clientWidth;
      if (maxScroll > 0) {
        const percentage = (slider.scrollLeft / maxScroll) * 100;
        progressBar.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
      }
    };

    slider.addEventListener('scroll', updateProgress);
    window.addEventListener('resize', updateProgress);
    // Inicializar barra
    setTimeout(updateProgress, 100); 

    // --- 3. BOTONES ---
    if (btnPrev && btnNext) {
      const scrollAmount = 300; 
      btnPrev.addEventListener('click', () => {
        slider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      });
      btnNext.addEventListener('click', () => {
        slider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      });
    }
  }

  // Ejecutar script
  initSlider();
  document.addEventListener('astro:page-load', initSlider);
</script>