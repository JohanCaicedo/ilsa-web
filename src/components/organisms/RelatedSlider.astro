---
import OpinionCard from "../molecules/OpinionCard.astro";
import SliderArrow from "../atoms/SliderArrow.astro";
import SliderProgress from "../atoms/SliderProgress.astro";

interface Props {
  posts: any[];
}

const { posts } = Astro.props;
---

<section
  class="related-slider-container mx-auto mt-16 mb-16 w-full max-w-[1400px] px-4 md:px-8 relative group"
  data-slider-type="related"
>
  <div class="mb-6 flex items-end justify-between border-b border-border pb-4">
    <h3
      class="text-xl md:text-2xl font-black tracking-tighter text-foreground uppercase"
    >
      Últimos Artículos
    </h3>

    <div class="hidden md:flex items-center gap-2">
      <SliderArrow direction="left" data-slider-prev />
      <SliderArrow direction="right" data-slider-next />
    </div>
  </div>

  <div
    class="flex w-full gap-6 overflow-x-auto py-4 px-1 cursor-grab active:cursor-grabbing select-none [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden snap-x snap-mandatory"
    data-slider-track
  >
    {
      posts.map((post) => {
        const img =
          post.featuredImage?.node?.sourceUrl ||
          "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Crect fill='%23e5e7eb' width='400' height='400'/%3E%3C/svg%3E";
        const authorName = post.categories?.nodes[0]?.name || "Opinión";
        const formattedDate = new Date(post.date).toLocaleDateString("es-CO", {
          day: "numeric",
          month: "short",
        });

        return (
          <div class="snap-start shrink-0 transition-opacity duration-300">
            <OpinionCard
              title={post.title}
              author={authorName}
              image={img}
              date={formattedDate}
              uri={post.uri}
            />
          </div>
        );
      })
    }
  </div>

  <SliderProgress data-slider-progress />
</section>

<script>
  function setupSliders() {
    const containers = document.querySelectorAll(
      '[data-slider-type="related"]',
    );

    containers.forEach((container) => {
      const track = container.querySelector(
        "[data-slider-track]",
      ) as HTMLElement | null;
      const progress = container.querySelector(
        "[data-slider-progress]",
      ) as HTMLElement | null;
      const btnPrev = container.querySelector("[data-slider-prev]");
      const btnNext = container.querySelector("[data-slider-next]");

      if (!track || !progress) return;

      // 1. Drag & Drop Logic
      let isDown = false;
      let startX = 0;
      let scrollLeft = 0;
      let moved = false;

      track.addEventListener("mousedown", (e: MouseEvent) => {
        isDown = true;
        moved = false;
        track.classList.add("active");
        const rect = track.getBoundingClientRect();
        startX = e.pageX - rect.left;
        scrollLeft = track.scrollLeft;

        // Disable snap and smooth behavior for direct feel
        track.style.scrollSnapType = "none";
        track.style.scrollBehavior = "auto";
      });

      const stopDragging = () => {
        if (!isDown) return;
        isDown = false;
        track.classList.remove("active");
        track.style.scrollSnapType = "x mandatory";
        track.style.scrollBehavior = "smooth";
      };

      track.addEventListener("mouseleave", stopDragging);
      track.addEventListener("mouseup", stopDragging);

      track.addEventListener("mousemove", (e: MouseEvent) => {
        if (!isDown) return;

        const rect = track.getBoundingClientRect();
        const x = e.pageX - rect.left;
        const walk = x - startX;

        if (Math.abs(walk) > 5) {
          moved = true;
          e.preventDefault();
          track.scrollLeft = scrollLeft - walk;
        }
      });

      // Prevent clicks on links IF we moved
      track.addEventListener(
        "click",
        (e: MouseEvent) => {
          if (moved) {
            e.preventDefault();
            e.stopPropagation();
            moved = false;
          }
        },
        true,
      ); // Capture phase to catch link clicks early

      // 2. Progress Logic
      const updateProgress = () => {
        const maxScroll = track.scrollWidth - track.clientWidth;
        if (maxScroll > 0) {
          const percentage = (track.scrollLeft / maxScroll) * 100;
          progress.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
        }
      };

      track.addEventListener("scroll", updateProgress);
      window.addEventListener("resize", updateProgress);
      setTimeout(updateProgress, 100);

      // 3. Arrow Logic
      if (btnPrev && btnNext) {
        btnPrev.addEventListener("click", () => {
          track.scrollBy({ left: -320, behavior: "smooth" });
        });
        btnNext.addEventListener("click", () => {
          track.scrollBy({ left: 320, behavior: "smooth" });
        });
      }
    });
  }

  // Initial load
  setupSliders();
  // Astro Page Loads
  document.addEventListener("astro:page-load", setupSliders);
</script>
