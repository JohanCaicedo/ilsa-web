---
import { Image } from "astro:assets";
import { cn } from "../../lib/utils";

interface Props {
    src: string;
    alt: string;
    width?: number;
    height?: number;
    class?: string;
    priority?: boolean;
    shouldOptimize?: boolean;
    style?: string;
}

const {
    src,
    alt,
    class: className,
    width = 800,
    height = 600,
    priority = false,
    shouldOptimize = true,
    ...rest
} = Astro.props;
---

{
    shouldOptimize ? (
        <Image
            src={src}
            alt={alt}
            width={width}
            height={height}
            loading={priority ? "eager" : "lazy"}
            decoding="async"
            fetchpriority={priority ? "high" : "auto"}
            class={cn(
                "transition-opacity duration-700 ease-in-out opacity-0 data-[loaded=true]:opacity-100",
                "translate-z-0 backface-hidden",
                className,
            )}
            onload="this.setAttribute('data-loaded', 'true')"
            {...rest}
        />
    ) : (
        <img
            src={src}
            alt={alt}
            width={width}
            height={height}
            loading={priority ? "eager" : "lazy"}
            decoding="async"
            class={cn(
                "transition-opacity duration-700 ease-in-out opacity-0 data-[loaded=true]:opacity-100",
                "translate-z-0 backface-hidden object-cover",
                className,
            )}
            onload="this.setAttribute('data-loaded', 'true')"
            {...rest}
        />
    )
}

<script>
    function checkImages() {
        const images = document.querySelectorAll('img[data-loaded!="true"]');
        images.forEach((img) => {
            if ((img as HTMLImageElement).complete) {
                img.setAttribute("data-loaded", "true");
            }
        });
    }

    // Run on init and view transitions
    document.addEventListener("astro:page-load", checkImages);
    document.addEventListener("DOMContentLoaded", checkImages);
</script>
