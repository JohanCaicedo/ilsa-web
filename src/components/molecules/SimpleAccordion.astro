---
import { cn } from "../../lib/utils";

interface Props {
    title: string;
    isOpen?: boolean;
    class?: string;
}

const { title, isOpen = false, class: className } = Astro.props;
const id = `acc-${Math.random().toString(36).substr(2, 9)}`;
---

<div
    class={cn(
        "border-b border-gray-200 last:border-0 accordion-item",
        className,
    )}
    data-open={isOpen ? "true" : "false"}
>
    <button
        type="button"
        aria-expanded={isOpen}
        aria-controls={id}
        class="accordion-trigger flex w-full cursor-pointer items-center justify-between py-5 text-left font-bold uppercase tracking-wide text-slate-900 transition-colors hover:text-[#4e7cce] focus:outline-none group"
    >
        <span>{title}</span>
        <span
            class="ml-4 flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-slate-50 text-slate-400 group-hover:bg-blue-50 group-hover:text-blue-500 transition-all duration-500 ease-[cubic-bezier(0.87,0,0.13,1)]"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="h-4 w-4 transition-transform duration-500 ease-[cubic-bezier(0.87,0,0.13,1)] icon-plus"
            >
                <path d="M12 5v14"></path>
                <path d="M5 12h14"></path>
            </svg>
        </span>
    </button>
    <div
        id={id}
        class="accordion-content overflow-hidden transition-all duration-500 ease-[cubic-bezier(0.87,0,0.13,1)]"
        style={isOpen ? "max-height: none;" : "max-height: 0px;"}
    >
        <div class="pb-6 text-sm leading-relaxed text-slate-600">
            <slot />
        </div>
    </div>
</div>

<script>
    // Define the handler function separately so it doesn't get redefined on every page load
    const handleAccordionClick = (e: Event) => {
        const target = e.target as HTMLElement;
        const trigger = target.closest(".accordion-trigger") as HTMLElement;

        if (!trigger) return;

        const item = trigger.closest(".accordion-item");
        if (!item) return;

        const isOpen = item.getAttribute("data-open") === "true";
        const contentInner = item.querySelector(
            ".accordion-content",
        ) as HTMLElement;
        const iconInner = item.querySelector(".icon-plus");

        if (isOpen) {
            // CLOSE
            item.setAttribute("data-open", "false");
            trigger.setAttribute("aria-expanded", "false");
            trigger.classList.remove("active");
            iconInner?.classList.remove("rotate-45");
            if (contentInner) contentInner.style.maxHeight = "0px";
        } else {
            // OPEN
            item.setAttribute("data-open", "true");
            trigger.setAttribute("aria-expanded", "true");
            trigger.classList.add("active");
            iconInner?.classList.add("rotate-45");
            if (contentInner)
                contentInner.style.maxHeight = contentInner.scrollHeight + "px";
        }
    };

    function setupAccordions() {
        // Initialize state for elements present in DOM (e.g. server-rendered open items)
        document.querySelectorAll(".accordion-item").forEach((item) => {
            // Only initialize if not already done (though for simple styling it's cheap to redo)
            if (item.getAttribute("data-open") === "true") {
                const trigger = item.querySelector(".accordion-trigger");
                const icon = item.querySelector(".icon-plus");
                const content = item.querySelector(
                    ".accordion-content",
                ) as HTMLElement;

                trigger?.classList.add("active");
                icon?.classList.add("rotate-45");
                if (content)
                    content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    }

    // Attach the event listener ONCE to the document (delegation)
    // We check if it's already attached to avoid duplicates in dev/hot-reload
    const win = window as any;
    if (!win.hasAccordionListener) {
        document.addEventListener("click", handleAccordionClick);
        win.hasAccordionListener = true;
    }

    // Re-run setup on every navigation to handle new DOM elements
    document.addEventListener("astro:page-load", setupAccordions);

    // Also run immediately in case the script loads after the event
    setupAccordions();
</script>
