---
interface Props {
    totalPages: number;
    gridId?: string;
    cardClass?: string;
    postsPerPage?: number;
}

const {
    totalPages,
    gridId = "posts-grid",
    cardClass = "post-card",
    postsPerPage = 12,
} = Astro.props;
---

{
    totalPages > 1 && (
        <div class="mb-12 flex justify-center">
            <div
                class="inline-flex gap-2 p-3 bg-white/40 backdrop-blur-md rounded-full border border-white/60 shadow-lg"
                id={`tab-container-${gridId}`}
                data-posts-per-page={postsPerPage}
            >
                {[...Array(totalPages)].map((_, i) => (
                    <button
                        type="button"
                        class={`pagination-btn tab-btn-${gridId} relative w-11 h-11 rounded-full flex items-center justify-center text-sm font-black transition-all duration-300 ease-out touch-action-manipulation focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ilsa-blue)] focus-visible:ring-offset-2 ${
                            i === 0
                                ? "bg-gradient-to-br from-[var(--ilsa-blue)] to-[var(--ilsa-mujeres)] text-white shadow-lg scale-110"
                                : "text-slate-500 hover:text-white hover:scale-105"
                        }`}
                        data-page={i}
                        data-grid={gridId}
                        data-card={cardClass}
                    >
                        <span class="relative z-10">{i + 1}</span>

                        {/* Hover glow effect */}
                        {i !== 0 && (
                            <div class="absolute inset-0 rounded-full bg-gradient-to-br from-[var(--ilsa-blue)]/80 to-[var(--ilsa-mujeres)]/80 opacity-0 transition-opacity duration-300 group-hover:opacity-100" />
                        )}
                    </button>
                ))}
            </div>
        </div>
    )
}

<style>
    .pagination-btn {
        overflow: hidden;
    }

    .pagination-btn:not(.active-pagination)::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 9999px;
        background: linear-gradient(
            135deg,
            var(--ilsa-blue),
            var(--ilsa-mujeres)
        );
        opacity: 0;
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .pagination-btn:not(.active-pagination):hover::before {
        opacity: 1;
    }

    .pagination-btn:not(.active-pagination):hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 20px -4px rgba(34, 67, 149, 0.4);
    }

    .active-pagination {
        animation: pageActivate 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes pageActivate {
        0% {
            transform: scale(0.9);
            opacity: 0.7;
        }
        50% {
            transform: scale(1.15);
        }
        100% {
            transform: scale(1.1);
            opacity: 1;
        }
    }

    /* Ripple effect on click */
    .pagination-btn::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 9999px;
        background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.6) 0%,
            transparent 70%
        );
        opacity: 0;
        transform: scale(0);
        transition:
            transform 0.5s ease-out,
            opacity 0.5s ease-out;
        pointer-events: none;
    }

    .pagination-btn:active::after {
        transform: scale(1.5);
        opacity: 1;
        transition:
            transform 0.3s ease-out,
            opacity 0.1s ease-out;
    }
</style>

<script>
    function setupPagination() {
        const allTabs = document.querySelectorAll(
            "button[data-grid][data-card]",
        );

        if (allTabs.length === 0) return;

        allTabs.forEach((tab) => {
            // Check if listener is already attached to avoid duplicates in dev mode
            if (tab.hasAttribute("data-pagination-initialized")) return;

            tab.addEventListener("click", handlePaginationClick);
            tab.setAttribute("data-pagination-initialized", "true");
        });
    }

    function handlePaginationClick(e: Event) {
        const target = e.currentTarget as HTMLButtonElement;
        const gridId = target.dataset.grid;
        const cardClass = target.dataset.card;
        const page = parseInt(target.dataset.page || "0");
        const container = target.closest(
            "div[data-posts-per-page]",
        ) as HTMLElement;
        const postsPerPage = parseInt(container?.dataset.postsPerPage || "12");

        if (!gridId || !cardClass) return;

        // Update ALL tabs for this specific grid (top and bottom pagination)
        const gridTabs = document.querySelectorAll(
            `button[data-grid="${gridId}"]`,
        );

        gridTabs.forEach((t) => {
            t.classList.remove(
                "bg-gradient-to-br",
                "from-[var(--ilsa-blue)]",
                "to-[var(--ilsa-mujeres)]",
                "text-white",
                "shadow-lg",
                "scale-110",
                "active-pagination",
            );
            t.classList.add("text-slate-500");

            // Sync active state visually across top/bottom
            if (t.getAttribute("data-page") === page.toString()) {
                t.classList.remove("text-slate-500");
                t.classList.add(
                    "bg-gradient-to-br",
                    "from-[var(--ilsa-blue)]",
                    "to-[var(--ilsa-mujeres)]",
                    "text-white",
                    "shadow-lg",
                    "scale-110",
                    "active-pagination",
                );
            }
        });

        // Filter logic with staggered animation
        const posts = document.querySelectorAll(`.${cardClass}`);
        const start = page * postsPerPage;
        const end = start + postsPerPage;

        posts.forEach((post, index) => {
            const el = post as HTMLElement;
            if (index >= start && index < end) {
                el.classList.remove("hidden");
                el.classList.add("flex");

                // Staggered animation for each card
                const delay = (index - start) * 50; // 50ms stagger
                setTimeout(() => {
                    el.animate(
                        [
                            {
                                opacity: 0,
                                transform: "translateY(20px) scale(0.95)",
                                filter: "blur(4px)",
                            },
                            {
                                opacity: 1,
                                transform: "translateY(0) scale(1)",
                                filter: "blur(0px)",
                            },
                        ],
                        {
                            duration: 500,
                            easing: "cubic-bezier(0.16, 1, 0.3, 1)",
                            fill: "forwards",
                        },
                    );
                }, delay);
            } else {
                el.classList.add("hidden");
                el.classList.remove("flex");
            }
        });

        // Smooth scroll to top of grid with offset
        const grid = document.getElementById(gridId);
        if (grid) {
            const yOffset = -150;
            const y =
                grid.getBoundingClientRect().top + window.pageYOffset + yOffset;
            window.scrollTo({ top: y, behavior: "smooth" });
        }
    }

    // Initialize on every page navigation
    document.addEventListener("astro:page-load", setupPagination);

    // Immediate init for safety
    setupPagination();
</script>
