---
interface Props {
    totalPages: number;
    gridId?: string;
    cardClass?: string;
    postsPerPage?: number;
}

const {
    totalPages,
    gridId = "posts-grid",
    cardClass = "post-card",
    postsPerPage = 12,
} = Astro.props;
---

{
    totalPages > 1 && (
        <div class="mb-12 flex justify-center">
            <div
                class="inline-flex gap-3 p-2 bg-slate-50 rounded-full border border-slate-200 shadow-sm"
                id={`tab-container-${gridId}`}
                data-posts-per-page={postsPerPage}
            >
                {[...Array(totalPages)].map((_, i) => (
                    <button
                        type="button"
                        class={`tab-btn-${gridId} w-10 h-10 rounded-full flex items-center justify-center text-[11px] font-black transition-all ${i === 0 ? "bg-[#375a9e] text-white shadow-lg scale-110" : "text-slate-400 hover:text-[#4E7CCE]"}`}
                        data-page={i}
                        data-grid={gridId}
                        data-card={cardClass}
                    >
                        {i + 1}
                    </button>
                ))}
            </div>
        </div>
    )
}

<script>
    function setupPagination() {
        const allTabs = document.querySelectorAll(
            "button[data-grid][data-card]",
        );

        if (allTabs.length === 0) return;

        allTabs.forEach((tab) => {
            // Check if listener is already attached to avoid duplicates in dev mode
            if (tab.hasAttribute("data-pagination-initialized")) return;

            tab.addEventListener("click", handlePaginationClick);
            tab.setAttribute("data-pagination-initialized", "true");
        });
    }

    function handlePaginationClick(e: Event) {
        const target = e.currentTarget as HTMLButtonElement;
        const gridId = target.dataset.grid;
        const cardClass = target.dataset.card;
        const page = parseInt(target.dataset.page || "0");
        const container = target.closest(
            "div[data-posts-per-page]",
        ) as HTMLElement;
        const postsPerPage = parseInt(container?.dataset.postsPerPage || "12");

        if (!gridId || !cardClass) return;

        // Update ALL tabs for this specific grid (top and bottom pagination)
        const gridTabs = document.querySelectorAll(
            `button[data-grid="${gridId}"]`,
        );

        gridTabs.forEach((t) => {
            t.classList.remove(
                "bg-[#375a9e]",
                "text-white",
                "shadow-lg",
                "scale-110",
            );
            t.classList.add("text-slate-400");

            // Sync active state visually across top/bottom
            if (t.getAttribute("data-page") === page.toString()) {
                t.classList.remove("text-slate-400");
                t.classList.add(
                    "bg-[#375a9e]",
                    "text-white",
                    "shadow-lg",
                    "scale-110",
                );
            }
        });

        // Filter logic
        const posts = document.querySelectorAll(`.${cardClass}`);
        const start = page * postsPerPage;
        const end = start + postsPerPage;

        posts.forEach((post, index) => {
            const el = post as HTMLElement;
            if (index >= start && index < end) {
                el.classList.remove("hidden");
                el.classList.add("flex");
                el.animate(
                    [
                        { opacity: 0, transform: "scale(0.95)" },
                        { opacity: 1, transform: "scale(1)" },
                    ],
                    {
                        duration: 400,
                        easing: "cubic-bezier(0.16, 1, 0.3, 1)",
                    },
                );
            } else {
                el.classList.add("hidden");
                el.classList.remove("flex");
            }
        });

        // Scroll to top of grid
        const grid = document.getElementById(gridId);
        if (grid) {
            const yOffset = -150;
            const y =
                grid.getBoundingClientRect().top + window.pageYOffset + yOffset;
            window.scrollTo({ top: y, behavior: "smooth" });
        }
    }

    // Initialize on every page navigation
    document.addEventListener("astro:page-load", setupPagination);

    // Immediate init for safety
    setupPagination();
</script>
