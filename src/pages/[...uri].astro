---
import {
  wpQuery,
  MASTER_QUERY,
  type MasterQueryResponse,
  type PostNode,
} from "../lib/wp";
import Layout from "../layouts/Layout.astro";
import ArticlePost from "../components/organisms/ArticlePost.astro";
import RelatedSlider from "../components/organisms/RelatedSlider.astro";
import ReadingProgress from "../components/atoms/ReadingProgress.astro";
import { authorsConfig, defaultAuthor } from "../lib/authors";
import { cn } from "../lib/utils";
import { collectionsConfig } from "../lib/collections";

export const prerender = true;

export async function getStaticPaths() {
  const data: MasterQueryResponse = await wpQuery(MASTER_QUERY);
  const allPosts = data.posts.nodes;

  return allPosts.map((post) => ({
    params: {
      uri: post.uri === "/" ? undefined : post.uri.replace(/^\/|\/$/g, ""),
    },
    props: {
      post,
      allPosts, // Pass all posts to filter specific related ones at runtime
    },
  }));
}

interface Props {
  post: PostNode;
  allPosts: PostNode[];
}

const { post, allPosts } = Astro.props;
const currentUrl = Astro.url.href;

// 1. Identify Category
const primaryCategory = post.categories?.nodes[0];
const categorySlug = primaryCategory?.slug;
const categoryName = primaryCategory?.name || "Actualidad";

// 2. Author Logic (Only for Opinion)
const isOpinion = post.categories?.nodes.some((c) => c.slug === "opinion");

const authorKey = isOpinion
  ? (post.categories?.nodes.find((cat) =>
      Object.keys(authorsConfig).includes(cat.slug),
    )?.slug as keyof typeof authorsConfig | undefined)
  : undefined;

const authorData = authorKey ? authorsConfig[authorKey] : undefined;

// 3. Related Posts Logic
// Filter posts that share at least one category, prioritize same category
const relatedPosts = allPosts
  .filter((p) => p.uri !== post.uri) // Exclude current
  .filter((p) => {
    if (!categorySlug) return true; // If current has no cat, show any recent
    return p.categories.nodes.some((c) => c.slug === categorySlug);
  })
  .slice(0, 10)
  .map((p) => ({
    ...p,
    image:
      p.featuredImage?.node?.sourceUrl ||
      "https://ilsa.org.co/wp-content/uploads/2021/02/placeholder.jpg",
  }));

// 4. Breadcrumbs
const breadcrumbItems = [];
if (isOpinion) {
  breadcrumbItems.push({ label: "OpiniÃ³n", href: "/opinion" });
  if (authorData) {
    breadcrumbItems.push({
      label: authorData.name,
      href: `/opinion/${authorKey}`,
    });
  }
} else if (categorySlug) {
  // Check if this category corresponds to a Collection
  const collectionEntry = Object.entries(collectionsConfig).find(
    ([_, config]) => config.wpCategorySlug === categorySlug,
  );

  if (collectionEntry) {
    const [slug, config] = collectionEntry;
    breadcrumbItems.push({
      label: config.title,
      href: `/publicaciones/${slug}`,
    });
  } else {
    // Default fallback (e.g. for uncategorized or standard categories)
    breadcrumbItems.push({ label: categoryName, href: `/${categorySlug}` });
  }
}

breadcrumbItems.push({
  label: post.title,
  href: Astro.url.pathname,
});
---

<Layout
  title={post.seo?.title || post.title}
  seo={post.seo}
  width="wide"
  breadcrumbs={breadcrumbItems}
>
  <ReadingProgress />

  <div class="mx-auto max-w-3xl pt-4">
    <ArticlePost
      title={post.title}
      content={post.content}
      date={post.date}
      section={categoryName}
      authorName={authorData?.name}
      authorImg={authorData?.avatarImage}
      authorBio={authorData?.shortBio}
      authorSlug={authorKey}
      twitterUrl={authorData?.xUrl || ""}
      twitterHandle={authorData?.xHandle || ""}
      url={currentUrl}
    />
  </div>

  <div class="mt-20 border-t pt-10">
    <RelatedSlider posts={relatedPosts} />
  </div>
</Layout>
